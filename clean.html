<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تنظيف المباريات</title>
<style>
  body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; background: #f7f7f7; }
  #log { white-space: pre-line; background: #fff; border: 1px solid #ccc; padding: 15px; height: 350px; overflow-y: auto; margin-top: 15px; }
  button { background: #007bff; border: none; color: white; padding: 12px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; }
  button:disabled { background: #aaa; cursor: default; }
</style>
</head>
<body>

<h2>تنظيف المباريات</h2>
<button id="start-clean-btn">ابدأ التنظيف</button>

<div id="log"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// إعدادات Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB6ACvhgth3VXhoJJnNOZfIQBpXlTVWcGE",
  authDomain: "website-f388d.firebaseapp.com",
  projectId: "website-f388d",
  storageBucket: "website-f388d.appspot.com",
  messagingSenderId: "531820596793",
  appId: "1:531820596793:web:37dbfd0b9a3c7a3a0cc7e8",
  measurementId: "G-75KT28HL7H"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const logEl = document.getElementById('log');
const startBtn = document.getElementById('start-clean-btn');

function log(text) {
  logEl.textContent += text + '\n';
  logEl.scrollTop = logEl.scrollHeight;
}

async function fetchMatchStatus(matchId) {
  try {
    const res = await fetch(`https://ko.best-goal.live/state.php?match_id=${matchId}`, {cache: 'no-store'});
    if (!res.ok) return null;
    return await res.json();
  } catch {
    return null;
  }
}

async function cleanStreamsForMatch(matchId) {
  log(`🚀 فحص المباراة ${matchId}...`);
  const statusData = await fetchMatchStatus(matchId);

  if (!statusData || !statusData["Match-Status"]) {
    log(`⚠️ لم يتم الحصول على حالة المباراة ${matchId}.\n`);
    return;
  }

  if (statusData["Match-Status"].includes("انتهت")) {
    log(`✅ المباراة ${matchId} انتهت. جاري حذف السيرفرات...`);
    const streamsRef = collection(db, "matches", matchId, "streams");
    const streamsSnapshot = await getDocs(streamsRef);
    if (streamsSnapshot.empty) {
      log(`⚠️ لا توجد سيرفرات لحذفها في المباراة ${matchId}.\n`);
      return;
    }
    for (const streamDoc of streamsSnapshot.docs) {
      try {
        await deleteDoc(doc(db, "matches", matchId, "streams", streamDoc.id));
        log(`✔️ تم حذف سيرفر ${streamDoc.id}`);
      } catch {
        log(`❌ فشل حذف سيرفر ${streamDoc.id}`);
      }
    }
    log(`🔹 انتهى حذف السيرفرات للمباراة ${matchId}.\n`);
  } else {
    log(`⏳ المباراة ${matchId} ما زالت نشطة.\n`);
  }
}

async function startCleaning() {
  startBtn.disabled = true;
  logEl.textContent = '';
  log('🚀 بدء عملية التنظيف...');

  const matchesRef = collection(db, "matches");
  const matchesSnapshot = await getDocs(matchesRef);
  
  if (matchesSnapshot.empty) {
    log('❌ لا توجد مباريات في قاعدة البيانات.');
    startBtn.disabled = false;
    return;
  }

  log(`📦 عدد المباريات: ${matchesSnapshot.size}\n`);

  for (const matchDoc of matchesSnapshot.docs) {
    const matchId = matchDoc.id;
    await cleanStreamsForMatch(matchId);
  }

  log('✅ انتهت عملية التنظيف.');
  startBtn.disabled = false;
}

startBtn.addEventListener('click', startCleaning);
</script>

</body>
</html>
