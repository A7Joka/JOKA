<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯Ø§Ø© ØªÙ†Ø¸ÙŠÙ Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</title>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }
        h1 {
            color: #007bff;
            margin-bottom: 25px;
            font-size: 2em;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 20px;
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #status-messages {
            margin-top: 30px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .message {
            margin-bottom: 8px;
            line-height: 1.6;
            color: #495057;
            border-bottom: 1px dotted #ced4da;
            padding-bottom: 5px;
        }
        .message:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007bff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ø£Ø¯Ø§Ø© ØªÙ†Ø¸ÙŠÙ Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ğŸ§¹</h1>
        <button id="start-cleanup-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†Ø¸ÙŠÙ</button>
        <div id="status-messages">
            <p class="info">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†Ø¸ÙŠÙ" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIG & GLOBAL VARS (Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB6ACvhgth3VXhoJJnNOZfIQBpXlTVWcGE",
            authDomain: "website-f388d.firebaseapp.com",
            projectId: "website-f388d",
            storageBucket: "website-f388d.appspot.com",
            messagingSenderId: "531820596793",
            appId: "1:531820596793:web:37dbfd0b9a3c7a3a0cc7e8",
            measurementId: "G-75KT28HL7H"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const startCleanupBtn = document.getElementById('start-cleanup-btn');
        const statusMessagesDiv = document.getElementById('status-messages');

        // --- Helper function to append messages ---
        function appendMessage(message, type = 'info') {
            const p = document.createElement('p');
            p.classList.add('message', type);
            p.innerHTML = message;
            statusMessagesDiv.appendChild(p);
            statusMessagesDiv.scrollTop = statusMessagesDiv.scrollHeight; // Scroll to bottom
        }

       // ... (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚) ...

async function startCleanupProcess() {
    startCleanupBtn.disabled = true;
    statusMessagesDiv.innerHTML = ''; // Clear previous messages
    appendMessage('<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ...', 'info');

    try {
        // 1. Get all match documents from "matches" collection
        appendMessage('<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù…Ù† Firestore...', 'info');
        const matchesCollectionRef = collection(db, "matches");
        const matchesSnapshot = await getDocs(matchesCollectionRef);

        if (matchesSnapshot.empty) {
            appendMessage('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'success');
            startCleanupBtn.disabled = false;
            return;
        }

        appendMessage(`ğŸ’¡ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${matchesSnapshot.size} Ù…Ø¨Ø§Ø±Ø§Ø© ÙÙŠ Firestore.`, 'info');

        for (const matchDoc of matchesSnapshot.docs) {
            const matchId = matchDoc.id;
            appendMessage(`â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ID: <strong>${matchId}</strong>...`, 'info');

            // 2. Fetch match status from external API
            const apiUrl = `https://ko.best-goal.live/state.php?match_id=${matchId}`;
            let matchStatus = null;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                matchStatus = data['Match-Status'];
                if (!matchStatus) {
                    throw new Error("Match-Status not found in API response.");
                }
                appendMessage(`ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ID <strong>${matchId}</strong>: <strong>${matchStatus}</strong>`, 'info');
            } catch (apiError) {
                appendMessage(`âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø© <strong>${matchId}</strong> Ø£Ùˆ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡Ø§: ${apiError.message}`, 'error');
                appendMessage(`â¡ï¸ ØªØ®Ø·ÙŠ Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø© <strong>${matchId}</strong> Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ API.`, 'warning');
                continue; // Skip to the next match
            }

            // 3. Evaluate match status and delete streams if ended
            if (matchStatus === 'Ø¥Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©' || matchStatus === 'Ø¥Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© - Ø±ÙƒÙ„Ø§Øª Ø§Ù„ØªØ±Ø¬ÙŠØ­') {
                appendMessage(`ğŸ‰ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© <strong>${matchId}</strong> Ø§Ù†ØªÙ‡Øª. Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ø¨Ø«...`, 'info');

                const streamsCollectionRef = collection(db, "matches", matchId, "streams");
                const streamsSnapshot = await getDocs(streamsCollectionRef);

                if (streamsSnapshot.empty) {
                    appendMessage(`â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ±ÙØ±Ø§Øª Ø¨Ø« Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø© <strong>${matchId}</strong>.`, 'info');
                    // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ±ÙØ±Ø§ØªØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ø­Ø°ÙÙ‡.
                    continue; // Skip to the next match
                }

                let deletedCount = 0;
                for (const streamDoc of streamsSnapshot.docs) {
                    try {
                        await deleteDoc(doc(db, "matches", matchId, "streams", streamDoc.id));
                        appendMessage(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¨Ø« <strong>${streamDoc.id}</strong> Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø© <strong>${matchId}</strong>.`, 'success');
                        deletedCount++;
                    } catch (deleteError) {
                        appendMessage(`âŒ ÙØ´Ù„ Ø­Ø°Ù Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¨Ø« <strong>${streamDoc.id}</strong> Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø© <strong>${matchId}</strong>: ${deleteError.message}`, 'error');
                    }
                }
                appendMessage(`âœ… ØªÙ… Ø­Ø°Ù <strong>${deletedCount}</strong> Ø³ÙŠØ±ÙØ± Ø¨Ø« Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø© <strong>${matchId}</strong>.`, 'success');
            } else {
                appendMessage(`â­ï¸ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© <strong>${matchId}</strong> Ù„Ù… ØªÙ†ØªÙ‡Ù Ø¨Ø¹Ø¯ Ø£Ùˆ Ø­Ø§Ù„ØªÙ‡Ø§ ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø­Ø°Ù (${matchStatus}). ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ.`, 'info');
            }
            appendMessage('<hr>', 'info'); // Separator for readability
        }

        appendMessage('âœ¨ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§ÙƒØªÙ…Ù„Øª!', 'success');

    } catch (firestoreError) {
        appendMessage(`ğŸš¨ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firestore: ${firestoreError.message}`, 'error');
    } finally {
        startCleanupBtn.disabled = false;
    }
}

// ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯) ...

        // --- Event Listener ---
        startCleanupBtn.addEventListener('click', startCleanupProcess);
    </script>
</body>
</html>

