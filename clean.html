<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</title>
<style>
  body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; background: #f7f7f7; }
  #log { white-space: pre-line; background: #fff; border: 1px solid #ccc; padding: 15px; height: 350px; overflow-y: auto; margin-top: 15px; }
  button { background: #007bff; border: none; color: white; padding: 12px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; }
  button:disabled { background: #aaa; cursor: default; }
</style>
</head>
<body>

<h2>ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</h2>
<button id="start-clean-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†Ø¸ÙŠÙ</button>

<div id="log"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB6ACvhgth3VXhoJJnNOZfIQBpXlTVWcGE",
  authDomain: "website-f388d.firebaseapp.com",
  projectId: "website-f388d",
  storageBucket: "website-f388d.appspot.com",
  messagingSenderId: "531820596793",
  appId: "1:531820596793:web:37dbfd0b9a3c7a3a0cc7e8",
  measurementId: "G-75KT28HL7H"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const logEl = document.getElementById('log');
const startBtn = document.getElementById('start-clean-btn');

function log(text) {
  logEl.textContent += text + '\n';
  logEl.scrollTop = logEl.scrollHeight;
}

async function fetchMatchStatus(matchId) {
  try {
    const res = await fetch(`https://ko.best-goal.live/state.php?match_id=${matchId}`, {cache: 'no-store'});
    if (!res.ok) return null;
    return await res.json();
  } catch {
    return null;
  }
}

async function cleanStreamsForMatch(matchId) {
  log(`ğŸš€ ÙØ­Øµ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${matchId}...`);
  const statusData = await fetchMatchStatus(matchId);

  if (!statusData || !statusData["Match-Status"]) {
    log(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${matchId}.\n`);
    return;
  }

  if (statusData["Match-Status"].includes("Ø§Ù†ØªÙ‡Øª")) {
    log(`âœ… Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${matchId} Ø§Ù†ØªÙ‡Øª. Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª...`);
    const streamsRef = collection(db, "matches", matchId, "streams");
    const streamsSnapshot = await getDocs(streamsRef);
    if (streamsSnapshot.empty) {
      log(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ±ÙØ±Ø§Øª Ù„Ø­Ø°ÙÙ‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${matchId}.\n`);
      return;
    }
    for (const streamDoc of streamsSnapshot.docs) {
      try {
        await deleteDoc(doc(db, "matches", matchId, "streams", streamDoc.id));
        log(`âœ”ï¸ ØªÙ… Ø­Ø°Ù Ø³ÙŠØ±ÙØ± ${streamDoc.id}`);
      } catch {
        log(`âŒ ÙØ´Ù„ Ø­Ø°Ù Ø³ÙŠØ±ÙØ± ${streamDoc.id}`);
      }
    }
    log(`ğŸ”¹ Ø§Ù†ØªÙ‡Ù‰ Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${matchId}.\n`);
  } else {
    log(`â³ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${matchId} Ù…Ø§ Ø²Ø§Ù„Øª Ù†Ø´Ø·Ø©.\n`);
  }
}

async function startCleaning() {
  startBtn.disabled = true;
  logEl.textContent = '';
  log('ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ...');

  const matchesRef = collection(db, "matches");
  const matchesSnapshot = await getDocs(matchesRef);
  
  if (matchesSnapshot.empty) {
    log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
    startBtn.disabled = false;
    return;
  }

  log(`ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª: ${matchesSnapshot.size}\n`);

  for (const matchDoc of matchesSnapshot.docs) {
    const matchId = matchDoc.id;
    await cleanStreamsForMatch(matchId);
  }

  log('âœ… Ø§Ù†ØªÙ‡Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ.');
  startBtn.disabled = false;
}

startBtn.addEventListener('click', startCleaning);
</script>

</body>
</html>
