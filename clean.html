<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>أداة تنظيف السيرفرات — Hantera TV</title>
  <style>
    body { font-family: Inter, system-ui, sans-serif; background:#0f172a; color:#e6eef8; padding:20px; }
    .card { background:#0b1220; border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(2,6,23,0.6); }
    button { background:#06b6d4; color:#012; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; }
    button.warn { background:#f97316; color:#fff; }
    pre { white-space:pre-wrap; word-wrap:break-word; max-height:48vh; overflow:auto; background:#071024; padding:12px; border-radius:8px; }
    .controls { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    label { font-size:14px; }
    input[type=checkbox] { width:18px; height:18px; }
    .stats { display:flex; gap:12px; margin-top:8px; font-size:13px; color:#9fb7cb; }
  </style>
</head>
<body>
  <div class="card" style="max-width:980px;margin:0 auto;">
    <h1 style="margin:0 0 8px 0;">🧹 أداة تنظيف سيرفرات البث (Matches → streams)</h1>
    <p style="margin:0 0 12px 0;color:#9fb7cb">تتحقق من كل مباراة في مجموعة <code>matches</code> وتُزيل مستندات الـ <code>streams</code> للمباريات المنتهية. تعمل من المتصفح.</p>

    <div class="controls">
      <button id="startBtn">ابدأ التنظيف</button>
      <button id="clearLog" class="warn">مسح اللوغ</button>
      <label><input type="checkbox" id="dryRun" checked /> تجربة فقط (dry-run)</label>
      <label><input type="checkbox" id="delMatchIfEmpty" /> حذف مستند المباراة لو بقى بدون streams</label>
    </div>

    <div class="stats" id="stats">
      <div>مباريات مفحوصة: <strong id="checked">0</strong></div>
      <div>سيرفرات محذوفة: <strong id="deleted">0</strong></div>
      <div>أخطاء: <strong id="errors">0</strong></div>
    </div>

    <h3 style="margin-top:12px">لوغ التنفيذ</h3>
    <pre id="log">جاهز. اضغط "ابدأ التنظيف".</pre>

    <p style="margin-top:12px;color:#8aa6bf;font-size:13px">
      ملاحظة: اذا كانت قواعد Firestore تمنع الحذف من متصفحك، استخدم Cloud Function مع Admin SDK أو عدّل القواعد مؤقتاً للاختبار.
    </p>
  </div>

<script type="module">
  // --------------- تكوين Firebase (من الكونسول اللي شاركته) ----------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc, deleteDoc, query, where, limit
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB6ACvhgth3VXhoJJnNOZfIQBpXlTVWcGE",
    authDomain: "website-f388d.firebaseapp.com",
    projectId: "website-f388d",
    storageBucket: "website-f388d.firebasestorage.app",
    messagingSenderId: "531820596793",
    appId: "1:531820596793:web:37dbfd0b9a3c7a3a0cc7e8",
    measurementId: "G-75KT28HL7H"
  };

  // init
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------------- UI elements ----------------
  const startBtn = document.getElementById('startBtn');
  const logEl = document.getElementById('log');
  const dryRunEl = document.getElementById('dryRun');
  const deletedEl = document.getElementById('deleted');
  const checkedEl = document.getElementById('checked');
  const errorsEl = document.getElementById('errors');
  const clearLogBtn = document.getElementById('clearLog');
  const delMatchIfEmptyEl = document.getElementById('delMatchIfEmpty');

  let stats = { checked:0, deleted:0, errors:0 };

  function log(...messages){
    const time = new Date().toLocaleTimeString();
    logEl.textContent = `[${time}] ` + messages.join(' ') + "\\n" + logEl.textContent;
  }
  function updateStats(){ checkedEl.textContent = stats.checked; deletedEl.textContent = stats.deleted; errorsEl.textContent = stats.errors; }

  clearLogBtn.onclick = () => { logEl.textContent = ''; };

  // ------------- logic config -------------
  const API_ENDPOINT = "https://ko.best-goal.live/state.php?match_id=";
  // الحَاالت اللي نعتبرها "انتهت" بالضبط — عدّل هنا لو عايز حالات إضافية
  const FINISHED_STATUSES = new Set([
    "إنتهت المباراة",
    "إنتهت المباراة - ركلات الترجيح",
    "ended",
    "finished"
  ]);

  // rate limiter بسيط: عدد طلبات API متزامنة
  const MAX_CONCURRENCY = 6;

  // ------------- helper: limited concurrency runner -------------
  async function pMap(inputs, mapper, concurrency = 4){
    const result = [];
    const executing = [];
    for (const item of inputs){
      const p = Promise.resolve().then(() => mapper(item));
      result.push(p);
      executing.push(p);
      if (executing.length >= concurrency){
        await Promise.race(executing).catch(()=>{}); // swallow so loop continues, errors counted inside mapper
        // remove resolved
        for (let i = executing.length-1; i>=0; i--){
          if (executing[i].settled) executing.splice(i,1);
        }
      }
    }
    return Promise.allSettled(result);
  }

  // mark settled helper
  function markSettled(p){
    p.then(()=>p.settled = true, ()=>p.settled = true);
    return p;
  }

  // ------------- main cleaning function -------------
  async function runCleanup(){
    startBtn.disabled = true;
    const isDry = dryRunEl.checked;
    const delMatchIfEmpty = delMatchIfEmptyEl.checked;
    log("ابدأ الفحص. dry-run =", isDry ? "نعم" : "لا");

    try {
      const matchesCol = collection(db, "matches");
      const snapshot = await getDocs(matchesCol);
      if (snapshot.empty){
        log("ما فيش مباريات في مجموعة 'matches'. إيقاف.");
        startBtn.disabled = false;
        return;
      }
      const docs = [];
      snapshot.forEach(d => docs.push({ id: d.id, ref: d.ref }));

      log("عدد المباريات الموجودة:", docs.length);

      // process each match with limited concurrency
      const processMatch = async (m) => {
        stats.checked++; updateStats();
        const matchId = m.id;
        log("فحص المباراة:", matchId);

        // call external API
        let statusText = null;
        try{
          const res = await fetch(API_ENDPOINT + encodeURIComponent(matchId), {cache:"no-store"});
          if (!res.ok){
            throw new Error("API response " + res.status);
          }
          const json = await res.json().catch(()=>null);
          // try a few possible fields
          statusText = json?.["Match-Status"] ?? json?.match_status ?? json?.status ?? null;
          // fallback: if API returns raw text:
          if (!statusText && typeof json === "string") statusText = json;
          log("  status for", matchId, "→", statusText ?? "(غير معروف)");
        }catch(err){
          stats.errors++; updateStats();
          log("  خطأ أثناء جلب حالة المباراة", matchId, ":", err.message);
          return;
        }

        if (!statusText) return; // لا نعرف الحالة

        if (!FINISHED_STATUSES.has(statusText.trim())){
          log("  المباراة لم تنتهِ (تخطى).");
          return;
        }

        // المباراة انتهت — نحذف الـ streams
        log("  المباراة مُنتهية → تنظيف streams...");
        // جلب الـ streams subcollection
        try{
          const streamsColPath = `matches/${matchId}/streams`;
          // الحل البسيط: نفعل getDocs على المسار
          const streamsSnapshot = await getDocs(collection(db, "matches", matchId, "streams"));
          if (streamsSnapshot.empty){
            log("    لا توجد streams للمباراة:", matchId);
            if (delMatchIfEmpty && !isDry){
              log("    حذف مستند المباراة لأنه فارغ من streams:", matchId);
              await deleteDoc(doc(db, "matches", matchId));
            }
            return;
          }

          const deletes = [];
          streamsSnapshot.forEach(docSnap => {
            deletes.push({ id: docSnap.id, ref: docSnap.ref });
          });

          for (const s of deletes){
            if (isDry){
              log("    [dry] كان حيتم حذف stream:", s.id);
            }else{
              try{
                await deleteDoc(s.ref);
                stats.deleted++; updateStats();
                log("    حذف stream:", s.id);
              }catch(e){
                stats.errors++; updateStats();
                log("    خطأ أثناء حذف stream", s.id, ":", e.message);
              }
            }
          }

          // بعد حذف كل الـ streams، لو اختار المستخدم حذف المباراة لو فاضية
          if (!isDry && delMatchIfEmpty){
            // تحقق إن المجموعة الفرعية فاضية
            const after = await getDocs(collection(db, "matches", matchId, "streams"));
            if (after.empty){
              try {
                await deleteDoc(doc(db, "matches", matchId));
                log("    حذف مستند المباراة بعد تنظيف streams:", matchId);
              } catch(e){
                stats.errors++; updateStats();
                log("    فشل حذف مستند المباراة:", e.message);
              }
            } else {
              log("    بعد الحذف، لا زالت هنالك streams لم تُحذف (ربما بسبب قواعد/permissions).");
            }
          }

        }catch(e){
          stats.errors++; updateStats();
          log("  خطأ أثناء الوصول لمجموعة streams:", e.message);
        }
      }; // end processMatch

      // use concurrency
      const mapper = (m) => markSettled(processMatch(m));
      const all = [];
      for (let i = 0; i < docs.length; i += MAX_CONCURRENCY){
        const chunk = docs.slice(i, i + MAX_CONCURRENCY).map(mapper);
        await Promise.all(chunk);
      }

      log("انتهت العملية. إجمالي مباريت مفحوصة:", stats.checked, "إجمالي محذوف:", stats.deleted, "أخطاء:", stats.errors);
    }catch(err){
      stats.errors++; updateStats();
      log("خطأ عام:", err.message);
    } finally {
      updateStats();
      startBtn.disabled = false;
    }
  }

  startBtn.onclick = runCleanup;

</script>
</body>
</html>
